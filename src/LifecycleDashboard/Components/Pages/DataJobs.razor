@page "/data-jobs"
@using DataIntegration = LifecycleDashboard.Services.DataIntegration
@inject NavigationManager Navigation
@inject DataIntegration.IDataSyncOrchestrator SyncOrchestrator
@inject DataIntegration.IAzureDevOpsService AzureDevOpsService
@inject DataIntegration.ISharePointService SharePointService
@inject DataIntegration.IServiceNowService ServiceNowService
@inject DataIntegration.IIisDatabaseService IisDatabaseService
@implements IDisposable

<PageTitle>Data Jobs - Lifecycle Dashboard</PageTitle>

<div class="data-jobs-page">
    <header class="page-header">
        <div class="header-content">
            <h1>Data Jobs</h1>
            <p class="subtitle">Monitor and manage data synchronization</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" @onclick="RefreshStatus">
                <i class="bi bi-arrow-repeat"></i> Refresh Status
            </button>
            <button class="btn btn-primary" @onclick="RunAllJobs" disabled="@_isRunningAll">
                @if (_isRunningAll)
                {
                    <span class="spinner-sm"></span>
                    <span>Running...</span>
                }
                else
                {
                    <i class="bi bi-play-fill"></i>
                    <span>Run All Jobs</span>
                }
            </button>
        </div>
    </header>

    <!-- Data Sources Overview -->
    <section class="data-sources-section">
        <h2>Data Sources</h2>
        <div class="sources-grid">
            @foreach (var source in _dataSources)
            {
                <div class="source-card @source.Status.ToLower()">
                    <div class="source-header">
                        <div class="source-icon">@((MarkupString)source.Icon)</div>
                        <div class="source-info">
                            <h3>@source.Name</h3>
                            <span class="source-type">@source.Type</span>
                        </div>
                        <span class="status-badge @source.Status.ToLower()">@GetStatusLabel(source.Status)</span>
                    </div>
                    <div class="source-body">
                        @if (_runningSource == source.Name && _currentProgress != null)
                        {
                            <div class="sync-progress">
                                <div class="progress-header">
                                    <span class="progress-phase">@_currentProgress.Phase</span>
                                    <span class="progress-percent">@_currentProgress.ProgressPercent%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" style="width: @(_currentProgress.ProgressPercent)%"></div>
                                </div>
                                @if (!string.IsNullOrEmpty(_currentProgress.CurrentItem))
                                {
                                    <div class="progress-current">@_currentProgress.CurrentItem</div>
                                }
                                @if (_currentProgress.TotalItems > 0)
                                {
                                    <div class="progress-counts">@_currentProgress.ProcessedItems of @_currentProgress.TotalItems</div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="source-stats">
                                <div class="stat">
                                    <span class="stat-label">Last Sync</span>
                                    <span class="stat-value">@FormatDate(source.LastSync)</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">Records</span>
                                    <span class="stat-value">@source.RecordCount.ToString("N0")</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">Next Run</span>
                                    <span class="stat-value">@FormatNextRun(source.NextRun)</span>
                                </div>
                            </div>
                            <div class="source-schedule">
                                <i class="bi bi-calendar3 schedule-icon"></i>
                                <span>@source.Schedule</span>
                            </div>
                        }
                    </div>
                    <!-- Job Scope Section -->
                    <div class="source-scope">
                        <button class="scope-toggle" @onclick="() => ToggleScope(source.Name)">
                            <i class="bi bi-@(_expandedScopes.Contains(source.Name) ? "chevron-up" : "chevron-down")"></i>
                            What will run
                        </button>
                        @if (_expandedScopes.Contains(source.Name))
                        {
                            <div class="scope-details">
                                @foreach (var op in GetScopeOperations(source.Name))
                                {
                                    <div class="scope-operation">
                                        <i class="bi bi-@op.Icon"></i>
                                        <div class="scope-op-content">
                                            <span class="scope-op-name">@op.Name</span>
                                            <span class="scope-op-desc">@op.Description</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <div class="source-footer">
                        <button class="btn btn-sm btn-outline" @onclick='() => NavigateToConfig(source.Name)'>Configure</button>
                        <button class="btn btn-sm btn-primary" @onclick="() => RunJob(source)" disabled="@(_runningSource == source.Name)">
                            @if (_runningSource == source.Name)
                            {
                                <span class="spinner-sm"></span>
                            }
                            else
                            {
                                <i class="bi bi-play-fill"></i>
                            }
                            Run Now
                        </button>
                    </div>
                </div>
            }
        </div>
    </section>

    <!-- Job Statistics -->
    <section class="stats-section">
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-value">@_totalJobs</div>
                <div class="stat-label">Total Runs (30d)</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value">@_successfulJobs</div>
                <div class="stat-label">Successful</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value">@_warningJobs</div>
                <div class="stat-label">With Warnings</div>
            </div>
            <div class="stat-card error">
                <div class="stat-value">@_failedJobs</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>
    </section>

    <!-- Job Execution History -->
    <section class="history-section">
        <div class="section-header">
            <h2>Execution History</h2>
            <div class="filter-controls">
                <select class="filter-select" @bind="_sourceFilter" @bind:after="ApplyFilter">
                    <option value="">All Sources</option>
                    @foreach (var source in _dataSources)
                    {
                        <option value="@source.Name">@source.Name</option>
                    }
                </select>
                <select class="filter-select" @bind="_statusFilter" @bind:after="ApplyFilter">
                    <option value="">All Statuses</option>
                    <option value="Success">Success</option>
                    <option value="Warning">Warning</option>
                    <option value="Failed">Failed</option>
                </select>
            </div>
        </div>

        <div class="history-table-container">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Started</th>
                        <th>Duration</th>
                        <th>Records</th>
                        <th>Status</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var job in _filteredJobs)
                    {
                        <tr class="@job.Status.ToLower()">
                            <td>
                                <span class="job-source">@job.Source</span>
                            </td>
                            <td>@job.StartTime.ToString("MMM d, h:mm tt")</td>
                            <td>@FormatDuration(job.Duration)</td>
                            <td>
                                @if (job.RecordsProcessed > 0)
                                {
                                    <span>@job.RecordsProcessed.ToString("N0")</span>
                                    @if (job.RecordsUpdated > 0)
                                    {
                                        <span class="records-updated">(+@job.RecordsUpdated)</span>
                                    }
                                }
                                else
                                {
                                    <span class="no-data">-</span>
                                }
                            </td>
                            <td>
                                <span class="status-pill @job.Status.ToLower()">
                                    @GetStatusIcon(job.Status) @job.Status
                                </span>
                            </td>
                            <td>
                                <button class="btn-details" @onclick="() => ShowJobDetails(job)">
                                    View
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </section>

    <!-- Job Details Modal -->
    @if (_selectedJob != null)
    {
        <div class="modal-overlay" @onclick="CloseModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <button class="modal-close" @onclick="CloseModal"><i class="bi bi-x-lg"></i></button>
                <div class="modal-header @_selectedJob.Status.ToLower()">
                    <h3>@_selectedJob.Source Sync</h3>
                    <span class="status-pill @_selectedJob.Status.ToLower()">
                        @GetStatusIcon(_selectedJob.Status) @_selectedJob.Status
                    </span>
                </div>
                <div class="modal-body">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Started</span>
                            <span class="detail-value">@_selectedJob.StartTime.ToString("MMM d, yyyy h:mm:ss tt")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Duration</span>
                            <span class="detail-value">@FormatDuration(_selectedJob.Duration)</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Records Processed</span>
                            <span class="detail-value">@_selectedJob.RecordsProcessed.ToString("N0")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Records Updated</span>
                            <span class="detail-value">@_selectedJob.RecordsUpdated.ToString("N0")</span>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(_selectedJob.Message))
                    {
                        <div class="job-message @_selectedJob.Status.ToLower()">
                            <span class="message-icon">@GetStatusIcon(_selectedJob.Status)</span>
                            <span>@_selectedJob.Message</span>
                        </div>
                    }

                    @if (_selectedJob.Logs.Count > 0)
                    {
                        <div class="job-logs">
                            <h4>Execution Log</h4>
                            <div class="log-entries">
                                @foreach (var log in _selectedJob.Logs)
                                {
                                    <div class="log-entry @log.Level.ToLower()">
                                        <span class="log-time">@log.Timestamp.ToString("HH:mm:ss")</span>
                                        <span class="log-level">@log.Level</span>
                                        <span class="log-message">@log.Message</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<DataSource> _dataSources = [];
    private List<JobExecution> _allJobs = [];
    private List<JobExecution> _filteredJobs = [];
    private JobExecution? _selectedJob;

    private string _sourceFilter = "";
    private string _statusFilter = "";

    private int _totalJobs;
    private int _successfulJobs;
    private int _warningJobs;
    private int _failedJobs;

    private bool _isRunningAll;
    private string? _runningSource;
    private DataIntegration.SyncProgressEventArgs? _currentProgress;
    private HashSet<string> _expandedScopes = [];

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to progress updates
        SyncOrchestrator.SyncProgressUpdated += OnProgressUpdated;

        InitializeDataSources();
        await CheckConnectionStatusAsync();
        await LoadJobHistoryAsync();
        CalculateStatistics();
        ApplyFilter();
    }

    private void OnProgressUpdated(object? sender, DataIntegration.SyncProgressEventArgs e)
    {
        _currentProgress = e;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        SyncOrchestrator.SyncProgressUpdated -= OnProgressUpdated;
    }

    private async Task CheckConnectionStatusAsync()
    {
        // Check Azure DevOps connection
        var adoSource = _dataSources.FirstOrDefault(d => d.Name == "Azure DevOps");
        if (adoSource != null)
        {
            try
            {
                var result = await AzureDevOpsService.TestConnectionAsync();
                adoSource.Status = result.Success ? "Connected" : "Disconnected";
            }
            catch
            {
                adoSource.Status = "Disconnected";
            }
        }

        // Check SharePoint connection
        var spSource = _dataSources.FirstOrDefault(d => d.Name == "SharePoint");
        if (spSource != null)
        {
            try
            {
                var result = await SharePointService.TestConnectionAsync();
                spSource.Status = result.Success ? "Connected" : "Disconnected";
            }
            catch
            {
                spSource.Status = "Disconnected";
            }
        }

        // Check ServiceNow connection
        var snSource = _dataSources.FirstOrDefault(d => d.Name == "ServiceNow");
        if (snSource != null)
        {
            try
            {
                var result = await ServiceNowService.TestConnectionAsync();
                snSource.Status = result.Success ? "Connected" : "Disconnected";
            }
            catch
            {
                snSource.Status = "Disconnected";
            }
        }

        // Check IIS Database connection
        var iisSource = _dataSources.FirstOrDefault(d => d.Name == "IIS Database");
        if (iisSource != null)
        {
            try
            {
                var result = await IisDatabaseService.TestConnectionAsync();
                iisSource.Status = result.Success ? "Connected" : "Disconnected";
            }
            catch
            {
                iisSource.Status = "Disconnected";
            }
        }
    }

    private async Task LoadJobHistoryAsync()
    {
        try
        {
            var history = await SyncOrchestrator.GetSyncJobHistoryAsync(50);
            _allJobs = history.Select(j => new JobExecution
            {
                Id = j.Id,
                Source = j.DataSource.ToString(),
                StartTime = j.StartTime,
                Duration = j.EndTime.HasValue ? j.EndTime.Value - j.StartTime : TimeSpan.Zero,
                RecordsProcessed = j.RecordsProcessed,
                RecordsUpdated = j.RecordsCreated + j.RecordsUpdated,
                Status = j.Status switch
                {
                    DataIntegration.SyncJobStatus.Completed => "Success",
                    DataIntegration.SyncJobStatus.CompletedWithErrors => "Warning",
                    DataIntegration.SyncJobStatus.Failed => "Failed",
                    DataIntegration.SyncJobStatus.Running => "Running",
                    _ => "Unknown"
                },
                Message = j.ErrorMessage ?? (j.Status == DataIntegration.SyncJobStatus.Completed ? "Successfully synchronized data" : ""),
                Logs = []
            }).OrderByDescending(j => j.StartTime).ToList();
        }
        catch
        {
            // Fall back to empty list if service fails
            _allJobs = [];
        }
    }

    private void InitializeDataSources()
    {
        var now = DateTimeOffset.UtcNow;

        _dataSources = new List<DataSource>
        {
            new()
            {
                Name = "Azure DevOps",
                Type = "REST API",
                Icon = "<i class=\"bi bi-globe\"></i>",
                Status = "Checking...",
                Schedule = "Weekly (Sundays @ 2:00 AM)",
                LastSync = null,
                NextRun = now.AddDays(1),
                RecordCount = 0,
                DataSourceType = DataIntegration.DataSourceType.AzureDevOps
            },
            new()
            {
                Name = "SharePoint",
                Type = "Graph API",
                Icon = "<i class=\"bi bi-file-earmark-text\"></i>",
                Status = "Checking...",
                Schedule = "Weekly (Sundays @ 3:00 AM)",
                LastSync = null,
                NextRun = now.AddDays(1),
                RecordCount = 0,
                DataSourceType = DataIntegration.DataSourceType.SharePoint
            },
            new()
            {
                Name = "ServiceNow",
                Type = "CSV Import",
                Icon = "<i class=\"bi bi-database\"></i>",
                Status = "Checking...",
                Schedule = "Weekly (Manual trigger)",
                LastSync = null,
                NextRun = null,
                RecordCount = 0,
                DataSourceType = DataIntegration.DataSourceType.ServiceNow
            },
            new()
            {
                Name = "IIS Database",
                Type = "SQL Query",
                Icon = "<i class=\"bi bi-server\"></i>",
                Status = "Checking...",
                Schedule = "Weekly (Sundays @ 4:00 AM)",
                LastSync = null,
                NextRun = now.AddDays(1),
                RecordCount = 0,
                DataSourceType = DataIntegration.DataSourceType.IisDatabase
            }
        };

        _allJobs = [];
    }

    private void CalculateStatistics()
    {
        _totalJobs = _allJobs.Count;
        _successfulJobs = _allJobs.Count(j => j.Status == "Success");
        _warningJobs = _allJobs.Count(j => j.Status == "Warning");
        _failedJobs = _allJobs.Count(j => j.Status == "Failed");
    }

    private void ApplyFilter()
    {
        var filtered = _allJobs.AsEnumerable();

        if (!string.IsNullOrEmpty(_sourceFilter))
        {
            filtered = filtered.Where(j => j.Source == _sourceFilter);
        }

        if (!string.IsNullOrEmpty(_statusFilter))
        {
            filtered = filtered.Where(j => j.Status == _statusFilter);
        }

        _filteredJobs = filtered.ToList();
    }

    private async Task RefreshStatus()
    {
        await CheckConnectionStatusAsync();
        await LoadJobHistoryAsync();
        CalculateStatistics();
        ApplyFilter();
        StateHasChanged();
    }

    private async Task RunAllJobs()
    {
        _isRunningAll = true;
        StateHasChanged();

        foreach (var source in _dataSources)
        {
            await RunJobInternal(source);
        }

        _isRunningAll = false;
        StateHasChanged();
    }

    private async Task RunJob(DataSource source)
    {
        _runningSource = source.Name;
        _currentProgress = null;
        StateHasChanged();

        await RunJobInternal(source);

        _runningSource = null;
        _currentProgress = null;
        StateHasChanged();
    }

    private async Task RunJobInternal(DataSource source)
    {
        var startTime = DateTimeOffset.UtcNow;

        try
        {
            // Call the real sync orchestrator
            var result = await SyncOrchestrator.SyncDataSourceAsync(source.DataSourceType, "Manual trigger");

            var job = new JobExecution
            {
                Id = Guid.NewGuid().ToString(),
                Source = source.Name,
                StartTime = startTime,
                Duration = DateTimeOffset.UtcNow - startTime,
                RecordsProcessed = result.RecordsProcessed,
                RecordsUpdated = result.RecordsCreated + result.RecordsUpdated,
                Status = result.Success ? "Success" : (result.Errors.Count > 0 ? "Failed" : "Warning"),
                Message = result.Success
                    ? $"Successfully synchronized {result.RecordsProcessed} records from {source.Name}"
                    : result.ErrorMessage ?? $"Sync failed for {source.Name}",
                Logs = result.Errors.Select(e => new LogEntry
                {
                    Timestamp = DateTimeOffset.UtcNow,
                    Level = "ERROR",
                    Message = e.Message
                }).ToList()
            };

            // Update source status
            source.LastSync = DateTimeOffset.UtcNow;
            source.RecordCount = result.RecordsProcessed;

            _allJobs.Insert(0, job);
        }
        catch (Exception ex)
        {
            var job = new JobExecution
            {
                Id = Guid.NewGuid().ToString(),
                Source = source.Name,
                StartTime = startTime,
                Duration = DateTimeOffset.UtcNow - startTime,
                RecordsProcessed = 0,
                RecordsUpdated = 0,
                Status = "Failed",
                Message = $"Error syncing {source.Name}: {ex.Message}",
                Logs = [new LogEntry { Timestamp = DateTimeOffset.UtcNow, Level = "ERROR", Message = ex.Message }]
            };

            _allJobs.Insert(0, job);
        }

        CalculateStatistics();
        ApplyFilter();
    }

    private void NavigateToConfig(string sourceName)
    {
        // Navigate to Admin page with tab and section specified
        Navigation.NavigateTo($"/admin?tab=data-sources&source={Uri.EscapeDataString(sourceName)}");
    }

    private void ToggleScope(string sourceName)
    {
        if (!_expandedScopes.Remove(sourceName))
        {
            _expandedScopes.Add(sourceName);
        }
    }

    private List<ScopeOperation> GetScopeOperations(string sourceName) => sourceName switch
    {
        "Azure DevOps" =>
        [
            new("List Repositories", "Retrieve all repositories from configured Azure DevOps project", "git"),
            new("Detect Tech Stacks", "Scan .csproj, package.json, requirements.txt, DESCRIPTION files", "code-slash"),
            new("Extract Packages", "Parse NuGet, npm, pip, and R package references with versions", "box-seam"),
            new("Analyze Commits", "Retrieve commit history for the past 365 days", "clock-history"),
            new("Check Pipelines", "Get latest build/pipeline status for each repository", "gear"),
            new("Scan README", "Check for README.md presence and basic quality", "file-text"),
            new("Detect Dependencies", "Scan config files for database connections and external services", "diagram-3")
        ],
        "SharePoint" =>
        [
            new("Discover Folders", "Find application documentation folders in configured SharePoint site", "folder"),
            new("Check Templates", "Verify presence of required documentation template folders", "file-check"),
            new("Assess Completeness", "Calculate documentation completeness score per application", "pie-chart"),
            new("Map to Applications", "Link SharePoint folders to application records", "link-45deg")
        ],
        "ServiceNow" =>
        [
            new("Import Applications", "Parse application CMDB records from CSV export", "upload"),
            new("Import Role Assignments", "Parse role assignment data from CSV export", "people"),
            new("Validate Users", "Cross-reference users against existing user records", "person-check"),
            new("Detect Conflicts", "Identify mismatched or duplicate records", "exclamation-triangle"),
            new("Update Applications", "Merge ServiceNow data into application records", "arrow-repeat")
        ],
        "IIS Database" =>
        [
            new("Query Usage Metrics", "Retrieve monthly request counts from IIS logs database", "graph-up"),
            new("Calculate Trends", "Analyze 12-month usage trends per application", "bar-chart-line"),
            new("Detect Inactive Apps", "Flag applications with zero or declining usage", "dash-circle"),
            new("Update Health Scores", "Factor usage data into application health calculations", "heart-pulse")
        ],
        _ => []
    };

    private void ShowJobDetails(JobExecution job)
    {
        _selectedJob = job;
    }

    private void CloseModal()
    {
        _selectedJob = null;
    }

    private static string GetStatusLabel(string status) => status switch
    {
        "Connected" => "Connected",
        "Disconnected" => "Not Connected",
        "Syncing" => "Syncing...",
        "Error" => "Error",
        _ => status
    };

    private static MarkupString GetStatusIcon(string status) => status switch
    {
        "Success" => new MarkupString("<i class=\"bi bi-check-lg\"></i>"),
        "Warning" => new MarkupString("<i class=\"bi bi-exclamation-triangle\"></i>"),
        "Failed" => new MarkupString("<i class=\"bi bi-x-lg\"></i>"),
        _ => new MarkupString("")
    };

    private static string FormatDate(DateTimeOffset? date)
    {
        if (!date.HasValue) return "Never";
        var days = (DateTimeOffset.UtcNow - date.Value).TotalDays;
        if (days < 1) return "Today";
        if (days < 2) return "Yesterday";
        if (days < 7) return $"{(int)days} days ago";
        return date.Value.ToString("MMM d");
    }

    private static string FormatNextRun(DateTimeOffset? date)
    {
        if (!date.HasValue) return "Manual";
        var hours = (date.Value - DateTimeOffset.UtcNow).TotalHours;
        if (hours < 1) return "Soon";
        if (hours < 24) return $"In {(int)hours}h";
        return date.Value.ToString("MMM d");
    }

    private static string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalMinutes < 1) return $"{(int)duration.TotalSeconds}s";
        if (duration.TotalHours < 1) return $"{(int)duration.TotalMinutes}m {duration.Seconds}s";
        return $"{(int)duration.TotalHours}h {duration.Minutes}m";
    }

    private class DataSource
    {
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";
        public string Icon { get; set; } = "";
        public string Status { get; set; } = "";
        public string Schedule { get; set; } = "";
        public DateTimeOffset? LastSync { get; set; }
        public DateTimeOffset? NextRun { get; set; }
        public int RecordCount { get; set; }
        public DataIntegration.DataSourceType DataSourceType { get; set; }
    }

    private class JobExecution
    {
        public string Id { get; set; } = "";
        public string Source { get; set; } = "";
        public DateTimeOffset StartTime { get; set; }
        public TimeSpan Duration { get; set; }
        public int RecordsProcessed { get; set; }
        public int RecordsUpdated { get; set; }
        public string Status { get; set; } = "";
        public string Message { get; set; } = "";
        public List<LogEntry> Logs { get; set; } = [];
    }

    private class LogEntry
    {
        public DateTimeOffset Timestamp { get; set; }
        public string Level { get; set; } = "";
        public string Message { get; set; } = "";
    }

    private record ScopeOperation(string Name, string Description, string Icon);
}
